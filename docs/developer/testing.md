# Developing and running tests

## Run vignette regression test suite

`riboviz.test.regression.test_regression` is a regression test suite. The regression test suite runs `riboviz.tools.prep_riboviz` using a given configuration file, then compares the results to a directory of pre-calculated results, specified by the user.

Usage:

```console
$ pytest riboviz/test/regression/test_regression.py \
    --expected=DIRECTORY \
    [--skip-workflow] \
    [--check-index-tmp] \
    [--config-file=FILE]
```

The test suite accepts the following command-line parameters:

* `--expected`: Directory with expected data files, against which files specified in the configuration file (see below) will be checked.
* `--skip-workflow`: Workflow will not be run prior to checking data files. This can be used to check existing files generated by a run of the workflow.
* `--check-index-tmp`: Check index and temporary files (default is that only the output files are checked).
* `--config-file`: Configuration file. If provided then the index, temporary and output directories specified in this file will be validated against those specified by `--expected`. If not provided then the file `vignette/vignette_config.yaml` will be used.

If the configuration specifies samples (`fq_files`) then `--check-index-tmp` can be used.

If the configuration specifies multiplexed samples (`multiplex_fq_files`) then `--check-index-tmp` cannot be used. The regression test module does not implement support for validating temporary files produced for worklows including demultiplexing. For sample-specific output files, each sample-specific output file is only validated if the directory with the expected results has a corresponding output file for the sample. This is because the sample names for the tests are derived from the sample sheet file (`sample_sheet`) and it can't be guaranteed that a sample in the sample sheet will yield corresponding sample files post-demultiplexing.

As the expected data directories and those with the data to be tested may vary in their paths the following approach is used:

* The paths of the directories with the data to be tested are taken to be those specified in the configuration file.
* The paths of the directories with the expected data are taken to be relative to the `--expected` directory and to share common names with the final directories of each path of the actual data directories.

For example, if the configuration file has:

```yaml
dir_index: vignette/index
dir_out: vignette/simdata_umi_output
dir_tmp: vignette/simdata_umi_tmp
```

and `--expected` is `/home/user/simdata-umi-data` then directories with the data to be tested are:

```
vignette/index
vignette/simdata_umi_output
vignette/simdata_umi_tmp
```

and the directories with the expected data are:

```
/home/user/simdata-umi-data/index
/home/user/simdata-umi-data/simdata_umi_output
/home/user/simdata-umi-data/simdata_umi_tmp
```

If running with a configuration that used UMI extraction, deduplication and grouping then note that:

* UMI deduplication statistics files are not checked (files prefixed by `dedup_stats`).
* UMI group file post-deduplication files, (`post_dedup_groups.tsv`) files can differ between runs depending on which reads are removed by `umi_tools dedup`, so only the existence of the file is checked.
* BAM file output by deduplication (`<SAMPLE>.bam`) files can differ between runs depending on which reads are removed by `umi_tools dedup`, so only the existence of the file is checked.

If `--check-index-tmp` is not provided (the default behaviour) then tests for index and temporary files will be skipped. This will appear as follows:

```console
$ pytest riboviz/test/regression/test_regression.py --expected=$HOME/vignette-20200304-2.0.beta --skip-workflow
...
riboviz/test/regression/test_regression.py ssssssssssssssssssssssssssssssssss..ssss......................................
```

or, if using pytest's `-v`, verbose, mode:

```console
$ pytest -v riboviz/test/regression/test_regression.py --expected=$HOME/vignette-20200304-2.0.beta --skip-workflow
...
riboviz/test/regression/test_regression.py::test_hisat2_build_index[YAL_CDS_w_250-vignette/index-1] SKIPPED [  1%]
...
riboviz/test/regression/test_regression.py::test_hisat2_build_index[YAL_CDS_w_250-vignette/index-8] SKIPPED [ 10%]
riboviz/test/regression/test_regression.py::test_hisat2_build_index[yeast_rRNA-vignette/index-1] SKIPPED [ 11%]
...
riboviz/test/regression/test_regression.py::test_hisat2_build_index[yeast_rRNA-vignette/index-8] SKIPPED [ 20%]
riboviz/test/regression/test_regression.py::test_cutadapt_fq[vignette/tmp-WTnone] SKIPPED [ 21%]
...
riboviz/test/regression/test_regression.py::test_bedtools_bedgraph[vignette/output-WTnone-minus.bedgraph] PASSED [ 52%]
...
riboviz/test/regression/test_regression.py::test_generate_stats_figs_pdf[vignette/output-WT3AT-3ntframe_propbygene.pdf] PASSED [ 97%]
riboviz/test/regression/test_regression.py::test_collate_tpms_tsv[vignette/output] PASSED [ 98%]
riboviz/test/regression/test_regression.py::test_read_counts_tsv[vignette/output] PASSED [100%]
```

### Regression test data

Regression test data can be found within repositories prefixed `regression-test-data-<YYYYMMDD>|<TAG>`, within the [riboviz](https://github.com/riboviz) project on GitHub. These contain output files from the workflow.

A regression test data repository can be used as follows (for example):

```console
$ git clone https://github.com/riboviz/regression-test-data-<YYYYMMDD>
$ cd riboviz
$ pytest riboviz/test/regression/test_regression.py --expected=$HOME/regression-test-data-<YYYYMMDD>
```

**Note:** The most recent `regression-test-data-<YYYYMMDD>` repository will be consistent with the most recent version of the code on the `develop` branch.

**Note:** `regression-test-data-<TAG>` repositories will be consistent with releases with tagged with `<TAG>`.

**Note:** Do not use the `--check-index-tmp` parameter when running regression tests using these repositories as the repositories contain no index or temporary files.

### Using your own regression test directory

After running the vignette you can copy `vignette` directory and then use that directory as the argument provided to the `--expected` parameter. This can be useful if you are changing any aspect of the workflow and want to ensure that you have not inadvertently changed the contents of the index or temporary files in any way.

For example:

```console
$ cp -r vignette/ ~/regression-test-data-<BRANCH>-<COMMIT-HASH>
```

Then, after doing some development, you can run:

```console
$ pytest riboviz/test/regression/test_regression.py \
    --expected=$HOME/regression-test-data-<BRANCH>-<COMMIT-HASH> \
    --check-index-tmp
```

Alternatively, you may find this useful if your changes *were* intended to change the contents of the index, temporary, or output, files - the copy of `vignette` serves as your new regression test directory. You could use this as a basis for [Creating a regression test data repository](./create-test-data-repository.md)

---

## Run all tests (excluding regression tests)

Run:

```console
$ pytest -v --ignore-glob="*regression*"
```

Run all tests and create a test coverage report which includes the line numbers of statements that were not executed:

```console
$ pytest --cov-config=.coveragerc --cov-report term-missing \
    --cov=riboviz --ignore-glob="*regression*"
```

---

## Useful pytest flags

* `-s`: disable output capture so, for example, `print` messages are shown.
* `-v`: verbose mode, displays names of test functions run.
* `-k`: run a specific test function.
